# yaml-language-server: $schema=https://api.omnistrate.cloud/2022-09-01-00/schema/service-spec-schema.json

name: $OmnistrateTierName
tenancyType: CUSTOM_TENANCY
deployment:
  hostedDeployment:
    GcpProjectId: "$GcpProjectId"
    GcpProjectNumber: "$GcpProjectNumber"
    GcpServiceAccountEmail: "$GcpServiceAccountEmail"
    AwsAccountId: "$AwsAccountId"
    AWSBootstrapRoleAccountArn: "$AwsBootstrapRoleAccountArn"
metering:
  gcsBucketName: $MeteringBucketName
pricing:
  - dimension: memory
    unit: GiB
    timeUnit: hour
    price: 0.1
maxNumberOfInstancesAllowed: 10
validPaymentMethodRequired: true
billingProductID: "startup"

services:
  - name: Standalone
    description: A FalkorDB Standalone database service managed by KubeBlocks.
    apiParameters:
      - key: enableTLS
        description: Whether to enable TLS for the database
        name: Enable TLS
        type: Boolean
        modifiable: true
        required: false
        export: true
        defaultValue: "false"
      - key: name
        description: Name
        name: Name
        type: String
        modifiable: true
        required: false
        defaultValue: My favorite database
        export: true
      - key: description
        description: Description
        name: Description
        type: String
        modifiable: true
        required: false
        defaultValue: Description
        export: true
      - key: memory
        description: The memory of the node instance. Check the documentation for more information.
        name: Memory
        type: String
        modifiable: true
        required: true
        export: true
        options:
          - 1Gi
          - 2Gi
      - key: enableTLS
        description: Whether to enable TLS for the database
        name: Enable TLS
        type: Boolean
        modifiable: false
        required: true
        export: true
        defaultValue: "false"
      - key: falkordbUser
        description: Choose a default username for your database
        name: FalkorDB User
        type: String
        modifiable: false
        required: true
        export: true
        defaultValue: "falkordb"
      - key: falkordbPassword
        description: Choose a default password for your database
        name: FalkorDB Password
        type: Password
        modifiable: false
        required: true
        export: false
      - key: RDBPersistenceConfig
        description: How often to save the RDB file to disk. Check the documentation for more information.
        name: RDB Persistence Config
        type: String
        modifiable: false
        required: false
        export: true
        defaultValue: "low"
        options:
          - "low"
          - "medium"
          - "high"
      - key: AOFPersistenceConfig
        description: Whether to enable AOF persistence. Check the documentation for more information.
        name: AOF Persistence Config
        type: String
        modifiable: false
        required: false
        export: true
        defaultValue: "everysec"
        options:
          - "everysec"
          - "always"
      - key: falkorDBCacheSize
        description: Choose the cache size for your database
        name: FalkorDB Cache Size
        type: Float64
        modifiable: false
        required: false
        export: true
        defaultValue: "25"
        limits:
          min: 0
          max: 256
      - key: falkorDBNodeCreationBuffer
        description: Choose the buffer size for your database
        name: FalkorDB Node Creation Buffer
        type: Float64
        modifiable: false
        required: false
        export: true
        defaultValue: "16384"
        limits:
          min: 256
          max: 32768
      - key: falkorDBMaxQueuedQueries
        description: Choose the max queued queries for your database
        name: FalkorDB Max Queued Queries
        type: Float64
        modifiable: false
        required: false
        export: true
        defaultValue: "50"
        limits:
          min: 0
          max: 512
      - key: falkorDBTimeoutMax
        description: Choose the timeout max for your database
        name: FalkorDB Timeout Max
        type: Float64
        modifiable: false
        required: false
        export: true
        defaultValue: "0"
        limits:
          min: 0
          max: 45000
      - key: falkorDBTimeoutDefault
        description: Choose the timeout default for your database
        name: FalkorDB Timeout Default
        type: Float64
        modifiable: false
        required: false
        export: true
        defaultValue: "0"
        limits:
          min: 0
          max: 45000
      - key: falkorDBResultSetSize
        description: Choose the result set size for your database
        name: FalkorDB Result Set Size
        type: Float64
        modifiable: false
        required: false
        export: true
        defaultValue: "10000"
        limits:
          min: 0
          max: 1000000
      - key: falkorDBQueryMemCapacity
        description: Choose the query mem capacity for your database
        name: FalkorDB Query Mem Capacity
        type: Float64
        modifiable: false
        required: false
        export: true
        defaultValue: "0"
        limits:
          min: 0
          max: 2000000000
    compute:
      instanceTypes:
        - cloudProvider: gcp
          name: e2-standard-4
        - cloudProvider: aws
          name: m6i.xlarge
    network:
      ports:
        - 6379
    helmChartConfiguration: 
      runtimeConfiguration:
        disableHooks: false
        wait: true
        waitForJobs: true
        recreate: false
        resetThenReuseValues: false
        resetValues: true
        reuseValues: false
        skipCRDs: false
        upgradeCRDs: true
        timeoutNanos: 180000000000
      chartName: falkordb-cluster-omnistrate
      chartVersion: $ChartVersion
      chartRepoName: falkordb-charts
      chartRepoURL: $ChartRepoURL
      chartValues:
        version: $FalkorDBServiceVersion
        mode: standalone
        replicas: 1
        storage: 20
        cpu: 0.1
        memory: $var.memory
        hostNetworkEnabled: true
        podAntiAffinityEnabled: true
        nodePortEnabled: false
        fixedPodIPEnabled: false
        loadBalancerEnabled: false
        hostPorts:
          - name: falkordb
            port: 6379
        extra:
          disableExporter: false
          terminationPolicy: Delete
        hostname: "$sys.network.externalClusterEndpoint"
        port: 6379

        # Sentinel not needed for standalone mode
        sentinel:
          enabled: false

        # Limited falkordb user credentials - passed to OpsRequest
        falkordbUser:
          username: $var.falkordbUser
          password: $var.falkordbPassword

        # FalkorDB module configuration
        falkordbConfig:
          cacheSize: $var.falkorDBCacheSize
          nodeCreationBuffer: $var.falkorDBNodeCreationBuffer
          maxQueuedQueries: $var.falkorDBMaxQueuedQueries
          timeoutMax: $var.falkorDBTimeoutMax
          timeoutDefault: $var.falkorDBTimeoutDefault
          resultSetSize: $var.falkorDBResultSetSize
          queryMemCapacity: $var.falkorDBQueryMemCapacity

        # Persistence configuration
        persistence:
          rdbConfig: $var.RDBPersistenceConfig
          aofConfig: $var.AOFPersistenceConfig

        # TLS (future implementation)
        enableTLS: $var.enableTLS

        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: omnistrate.com/managed-by
                    operator: In
                    values:
                      - omnistrate
                  - key: topology.kubernetes.io/region
                    operator: In
                    values:
                      - $sys.deploymentCell.region
                  - key: node.kubernetes.io/instance-type
                    operator: In
                    values:
                      - $sys.compute.node.instanceType
                  - key: omnistrate.com/resource
                    operator: In
                    values:
                      - $sys.deployment.resourceID
