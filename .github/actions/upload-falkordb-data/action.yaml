name: Upload FalkorDB Data from Deployment Cell
description: "Extract and upload RDB/AOF files from a deployment cell pod to Google Cloud Storage"

inputs:
  omnistrate_username:
    description: "Omnistrate login email"
    required: true
  omnistrate_password:
    description: "Omnistrate login password"
    required: true
  deployment_cell_id:
    description: "Deployment cell ID (e.g., hc-3m8vt5hy2)"
    required: true
  customer_email:
    description: "Customer email (required for customer-owned clusters)"
    required: false
    default: ""
  namespace:
    description: "Kubernetes namespace"
    required: true
  pod_name:
    description: "Pod name to extract data from"
    required: false
    default: "node-f-0"
  aof_enabled:
    description: "Include AOF files (true/false)"
    required: false
    default: "false"
  gcs_bucket:
    description: "GCS bucket name"
    required: false
    default: "falkordb_rdbs_test_eu"
  gcs_service_account:
    description: "Service account for GCS impersonation"
    required: false
    default: "falkordb-rdb-storage-reader@pipelines-development-f7a2434f.iam.gserviceaccount.com"
  gcs_region:
    description: "GCS region"
    required: false
    default: "eu"
  issue_number:
    description: "GitHub issue number to comment URLs on"
    required: true
  github_token:
    description: "GitHub token for commenting on issues"
    required: true

outputs:
  rdb_download_url:
    description: "Signed URL for RDB file (12h validity)"
    value: ${{ steps.generate_download_urls.outputs.rdb_url }}
  aof_download_url:
    description: "Signed URL for AOF file (12h validity, if AOF enabled)"
    value: ${{ steps.generate_download_urls.outputs.aof_url }}

runs:
  using: composite
  steps:
    - name: Setup omnistrate-ctl
      shell: bash
      run: |
        docker pull ghcr.io/omnistrate/ctl:0.9.89
        
    - name: Login to Omnistrate and update kubeconfig
      shell: bash
      env:
        OMNISTRATE_USER: ${{ inputs.omnistrate_username }}
        OMNISTRATE_PASS: ${{ inputs.omnistrate_password }}
        DEPLOYMENT_CELL: ${{ inputs.deployment_cell_id }}
        CUSTOMER_EMAIL: ${{ inputs.customer_email }}
      run: |
        # Login to Omnistrate
        docker run --rm \
          ghcr.io/omnistrate/ctl:0.9.89 \
          omnistrate-ctl login --email "$OMNISTRATE_USER" --password "$OMNISTRATE_PASS"
        
        # Update kubeconfig
        if [ -n "$CUSTOMER_EMAIL" ]; then
          docker run --rm -v $HOME/.kube:/root/.kube \
            ghcr.io/omnistrate/ctl:0.9.89 \
            omnistrate-ctl deployment-cell update-kubeconfig "$DEPLOYMENT_CELL" \
            --customer-email "$CUSTOMER_EMAIL" \
            --kubeconfig /root/.kube/omnistrate-config
        else
          docker run --rm -v $HOME/.kube:/root/.kube \
            ghcr.io/omnistrate/ctl:0.9.89 \
            omnistrate-ctl deployment-cell update-kubeconfig "$DEPLOYMENT_CELL" \
            --kubeconfig /root/.kube/omnistrate-config
        fi
        
        echo "KUBECONFIG=$HOME/.kube/omnistrate-config" >> $GITHUB_ENV
        
    - name: Generate GCS signed PUT URLs
      shell: bash
      id: generate_put_urls
      env:
        NAMESPACE: ${{ inputs.namespace }}
        GCS_BUCKET: ${{ inputs.gcs_bucket }}
        GCS_SA: ${{ inputs.gcs_service_account }}
        GCS_REGION: ${{ inputs.gcs_region }}
        AOF_ENABLED: ${{ inputs.aof_enabled }}
      run: |
        # Generate RDB PUT URL
        rdb_put_output=$(gcloud storage sign-url gs://${GCS_BUCKET}/${NAMESPACE}/dump.rdb \
          --duration 1h \
          --impersonate-service-account ${GCS_SA} \
          --region ${GCS_REGION} \
          --http-verb=PUT)
        
        rdb_put_url=$(echo "$rdb_put_output" | grep signed_url | awk '{print $2}')
        echo "rdb_put_url=$rdb_put_url" >> $GITHUB_OUTPUT
        
        # Generate AOF PUT URL if enabled
        if [ "$AOF_ENABLED" = "true" ]; then
          aof_put_output=$(gcloud storage sign-url gs://${GCS_BUCKET}/${NAMESPACE}/appendonlydir.tar.gz \
            --duration 1h \
            --impersonate-service-account ${GCS_SA} \
            --region ${GCS_REGION} \
            --http-verb=PUT)
          
          aof_put_url=$(echo "$aof_put_output" | grep signed_url | awk '{print $2}')
          echo "aof_put_url=$aof_put_url" >> $GITHUB_OUTPUT
        fi
        
    - name: Upload RDB file to GCS
      shell: bash
      env:
        NAMESPACE: ${{ inputs.namespace }}
        POD_NAME: ${{ inputs.pod_name }}
        RDB_PUT_URL: ${{ steps.generate_put_urls.outputs.rdb_put_url }}
      run: |
        kubectl exec -n "$NAMESPACE" "$POD_NAME" -- \
          curl -X PUT --fail \
          -H "Content-Type: application/octet-stream" \
          --upload-file /data/dump.rdb \
          "$RDB_PUT_URL"
        
        if [ $? -ne 0 ]; then
          echo "âŒ Failed to upload RDB file to GCS."
          exit 1
        fi
        echo "âœ… RDB file uploaded successfully to GCS."
        
    - name: Upload AOF files to GCS
      if: inputs.aof_enabled == 'true'
      shell: bash
      env:
        NAMESPACE: ${{ inputs.namespace }}
        POD_NAME: ${{ inputs.pod_name }}
        AOF_PUT_URL: ${{ steps.generate_put_urls.outputs.aof_put_url }}
      run: |
        # Tar the AOF directory
        kubectl exec -n "$NAMESPACE" "$POD_NAME" -- \
          tar -czvf /data/appendonlydir.tar.gz -C /data/appendonlydir .
        
        # Upload to GCS
        kubectl exec -n "$NAMESPACE" "$POD_NAME" -- \
          curl -X PUT --fail \
          -H "Content-Type: application/octet-stream" \
          --upload-file /data/appendonlydir.tar.gz \
          "$AOF_PUT_URL"
        
        if [ $? -ne 0 ]; then
          echo "âŒ Failed to upload AOF file to GCS."
          exit 1
        fi
        echo "âœ… AOF file uploaded successfully to GCS."
        
    - name: Generate GCS signed GET URLs
      shell: bash
      id: generate_download_urls
      env:
        NAMESPACE: ${{ inputs.namespace }}
        GCS_BUCKET: ${{ inputs.gcs_bucket }}
        GCS_SA: ${{ inputs.gcs_service_account }}
        GCS_REGION: ${{ inputs.gcs_region }}
        AOF_ENABLED: ${{ inputs.aof_enabled }}
      run: |
        # Generate RDB download URL (12h validity)
        rdb_download_output=$(gcloud storage sign-url gs://${GCS_BUCKET}/${NAMESPACE}/dump.rdb \
          --duration 12h \
          --impersonate-service-account ${GCS_SA} \
          --region ${GCS_REGION})
        
        rdb_url=$(echo "$rdb_download_output" | grep signed_url | awk '{print $2}')
        echo "rdb_url=$rdb_url" >> $GITHUB_OUTPUT
        echo "ðŸ“¥ RDB Download URL: $rdb_url"
        
        # Generate AOF download URL if enabled
        if [ "$AOF_ENABLED" = "true" ]; then
          aof_download_output=$(gcloud storage sign-url gs://${GCS_BUCKET}/${NAMESPACE}/appendonlydir.tar.gz \
            --duration 12h \
            --impersonate-service-account ${GCS_SA} \
            --region ${GCS_REGION})
          
          aof_url=$(echo "$aof_download_output" | grep signed_url | awk '{print $2}')
          echo "aof_url=$aof_url" >> $GITHUB_OUTPUT
          echo "ðŸ“¥ AOF Download URL: $aof_url"
        fi
        
    - name: Comment URLs on GitHub issue
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
        ISSUE_NUMBER: ${{ inputs.issue_number }}
        RDB_URL: ${{ steps.generate_download_urls.outputs.rdb_url }}
        AOF_URL: ${{ steps.generate_download_urls.outputs.aof_url }}
        AOF_ENABLED: ${{ inputs.aof_enabled }}
        NAMESPACE: ${{ inputs.namespace }}
      run: |
        cat << 'EOF' > comment.md
        ### ðŸ“Š Debug Data Available
        
        Namespace: `$NAMESPACE`
        
        **RDB Snapshot:** [Download dump.rdb]($RDB_URL) _(valid for 12 hours)_
        EOF
        
        if [ "$AOF_ENABLED" = "true" ]; then
          cat << 'EOF' >> comment.md
        
        **AOF Directory:** [Download appendonlydir.tar.gz]($AOF_URL) _(valid for 12 hours)_
        EOF
        fi
        
        cat << 'EOF' >> comment.md
        
        > Extract and load these files into a local FalkorDB instance to reproduce the crash.
        EOF
        
        # Expand environment variables in the comment
        comment_body=$(envsubst < comment.md)
        gh issue comment "$ISSUE_NUMBER" --body "$comment_body"
