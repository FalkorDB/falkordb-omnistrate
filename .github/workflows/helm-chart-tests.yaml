name: Helm Chart Tests

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    paths:
      - "helm/kubeblocks/**"
      - ".github/workflows/helm-chart-tests.yaml"
  push:
    tags:
      - "v*"
    paths:
      - "helm/kubeblocks/**"
  schedule:
    - cron: "0 0 * * *" # Run daily at midnight UTC
  workflow_dispatch:
    inputs:
      test_type:
        description: "Type of tests to run"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - unit
          - integration

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NAMESPACE: falkordb-test
  CLUSTER_NAME: test-cluster
  PYTHON_VERSION: "3.11"
  KIND_VERSION: "v0.20.0"
  KUBECTL_VERSION: "v1.28.0"
  HELM_VERSION: "v3.13.0"
  KUBEBLOCKS_VERSION: "v1.0.1"

jobs:
  unit-tests:
    name: Unit Tests (Manifest Rendering)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
      - name: Checkout
        uses: actions/checkout@v5
        with:
          repository: apecloud/kubeblocks-addons
          path: helm/kubeblocks/kubeblocks-addons
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Cache Poetry virtualenv
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry/virtualenvs
          key: ${{ runner.os }}-poetry-helm-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-poetry-helm-
            ${{ runner.os }}-poetry-

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        working-directory: .
        run: |
          poetry install

      - name: Build Helm chart dependencies
        working-directory: helm/kubeblocks/falkordb-cluster-omnistrate
        run: |
          helm dependency build

      - name: Run unit tests
        working-directory: helm/kubeblocks/falkordb-cluster-omnistrate/tests
        run: |
          poetry run pytest -v -n 3 --dist=loadfile --tb=short \
            --cluster-name=${{ env.CLUSTER_NAME }} \
            --namespace=${{ env.NAMESPACE }} \
            unit/

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: |
            helm/kubeblocks/falkordb-cluster-omnistrate/tests/.pytest_cache/
            helm/kubeblocks/falkordb-cluster-omnistrate/tests/test-results/

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' && inputs.test_type != 'unit') ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.test_type != 'unit')
    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - name: "Standalone Mode Integration Tests"
            path: "integration/standalone"
          - name: "Replication Mode Integration Tests"
            path: "integration/replication"
          - name: "Cluster Mode Integration Tests"
            path: "integration/cluster"
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Checkout
        uses: actions/checkout@v5
        with:
          repository: apecloud/kubeblocks-addons
          path: helm/kubeblocks/kubeblocks-addons

      - name: Verify submodules
        run: |
          echo "Checking submodule status..."
          git submodule status
          echo "Listing kubeblocks-addons directory..."
          ls -la helm/kubeblocks/kubeblocks-addons/ || echo "Directory not found"
          if [ ! -d "helm/kubeblocks/kubeblocks-addons/addons" ]; then
            echo "Submodule content not found, initializing manually..."
            git submodule update --init --recursive
          fi
          echo "Final check:"
          ls -la helm/kubeblocks/kubeblocks-addons/addons/ || echo "Addons directory still not found"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: ${{ env.KUBECTL_VERSION }}

      - name: Set up Kind
        uses: helm/kind-action@v1
        with:
          version: ${{ env.KIND_VERSION }}
          cluster_name: falkordb-test
          config: helm/kubeblocks/falkordb-cluster-omnistrate/tests/kind-config.yaml
          wait: 300s

      - name: Verify cluster
        run: |
          kubectl cluster-info
          kubectl get nodes
          kubectl wait --for=condition=Ready nodes --all --timeout=300s

      - name: Cache Poetry virtualenv
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry/virtualenvs
          key: ${{ runner.os }}-poetry-helm-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-poetry-helm-
            ${{ runner.os }}-poetry-

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install Python dependencies
        run: |
          poetry install

      - name: Install KubeBlocks CRDs
        run: |
          kubectl create -f https://github.com/apecloud/kubeblocks/releases/download/${{ env.KUBEBLOCKS_VERSION }}/kubeblocks_crds.yaml

      - name: Add KubeBlocks Helm repo
        run: |
          helm repo add kubeblocks https://apecloud.github.io/helm-charts
          helm repo update

      - name: Install KubeBlocks
        run: |
          helm install kubeblocks kubeblocks/kubeblocks \
            --namespace kb-system \
            --version ${{ env.KUBEBLOCKS_VERSION }} \
            --create-namespace \
            --set autoInstalledAddons={} \
            --wait \
            --timeout 10m

      - name: Wait for KubeBlocks pods
        run: |
          kubectl wait --for=condition=Ready pods --all -n kb-system --timeout=300s
          kubectl get pods -n kb-system

      - name: Install FalkorDB addon
        run: |
          ADDON_PATH="helm/kubeblocks/kubeblocks-addons/addons/falkordb"
          if [ -d "$ADDON_PATH" ]; then
            echo "Building FalkorDB addon dependencies..."
            helm dependency build "$ADDON_PATH" || true
            echo "Installing FalkorDB addon..."
            helm upgrade --install falkordb --namespace kb-system "$ADDON_PATH" --wait --timeout 5m
            sleep 10
            kubectl -n kb-system get clusterdefinitions
          else
            echo "FalkorDB addon directory not found at $ADDON_PATH"
            ls -la helm/kubeblocks/kubeblocks-addons/ || echo "kubeblocks-addons directory not found"
            exit 1
          fi

      - name: Verify FalkorDB addon
        run: |
          timeout=60
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            status=$(kubectl -n kb-system get clusterdefinitions falkordb -o jsonpath='{.status.phase}' 2>/dev/null || echo "")
            if [ "$status" = "Available" ]; then
              echo "FalkorDB addon is enabled"
              break
            fi
            echo "Waiting for addon to be enabled... (${elapsed}s/${timeout}s)"
            sleep 5
            elapsed=$((elapsed + 5))
          done
          kubectl -n kb-system get clusterdefinitions falkordb -o yaml

      - name: Create test namespace
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Build Helm chart dependencies
        working-directory: helm/kubeblocks/falkordb-cluster-omnistrate
        run: |
          helm dependency build

      - name: Cleanup existing test resources
        working-directory: helm/kubeblocks/falkordb-cluster-omnistrate/tests
        run: |
          # Cleanup any existing helm releases
          if helm list -n ${{ env.NAMESPACE }} --all 2>/dev/null | grep -q "test-cluster"; then
            helm uninstall test-cluster -n ${{ env.NAMESPACE }} || true
            sleep 5
          fi

          # Cleanup any leftover PVCs
          kubectl delete pvc -n ${{ env.NAMESPACE }} -l app.kubernetes.io/instance=test-cluster --ignore-not-found=true || true

      - name: Run ${{ matrix.test-suite.name }}
        working-directory: helm/kubeblocks/falkordb-cluster-omnistrate/tests
        run: |
          poetry run pytest -v -s --tb=short \
            --cluster-name=${{ env.CLUSTER_NAME }} \
            --namespace=${{ env.NAMESPACE }} \
            ${{ matrix.test-suite.path }}

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Cluster Definitions ==="
          kubectl get clusterdefinitions -n kb-system

          echo "=== Clusters ==="
          kubectl get clusters -n ${{ env.NAMESPACE }}

          echo "=== Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide

          echo "=== Pod Logs ==="
          for pod in $(kubectl get pods -n ${{ env.NAMESPACE }} -o name); do
            echo "--- $pod ---"
            kubectl logs -n ${{ env.NAMESPACE }} $pod --all-containers --tail=100 || true
          done

          echo "=== Events ==="
          kubectl get events -n ${{ env.NAMESPACE }} --sort-by='.lastTimestamp'

          echo "=== KubeBlocks Pods ==="
          kubectl get pods -n kb-system

          echo "=== KubeBlocks Logs ==="
          for pod in $(kubectl get pods -n kb-system -o name); do
            echo "--- $pod ---"
            kubectl logs -n kb-system $pod --tail=100 || true
          done

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results-${{ matrix.test-suite.name }}
          path: |
            helm/kubeblocks/falkordb-cluster-omnistrate/tests/.pytest_cache/
            helm/kubeblocks/falkordb-cluster-omnistrate/tests/test-results/

  omnistrate-e2e-tests:
    name: Omnistrate E2E Tests
    runs-on: ubuntu-latest
    if: always()
    env:
      # Test mode: basic runs on schedule/manual full, full runs on tags
      TEST_MODE: ${{ (contains(github.ref, 'refs/tags/v')) && 'full' || 'basic' }}
    strategy:
      fail-fast: false
      matrix:
        instances:
          ######################## NON-ENTERPRISE â€¢ AWS ONLY (BASIC) #####################
          - name: "[01] free/Standalone - AWS/us-east-1"
            if: "basic"
            testFile: tests/test_grouped_standalone.py
            tests: "failover,stopstart,oom"
            tierName: "Free"
            cloudProvider: aws
            cloudRegion: us-east-1
            resourceKey: free
            maxmemory: "1GB"

          - name: "[02] startup/Standalone - AWS/us-east-1"
            if: "basic"
            testFile: tests/test_grouped_standalone.py
            tests: "failover,stopstart,oom"
            tierName: "Startup"
            cloudProvider: aws
            cloudRegion: us-east-1
            resourceKey: standalone
            maxmemory: "1GB"

          - name: "[03] pro/Standalone - AWS/us-east-1"
            if: "basic"
            testFile: tests/test_grouped_standalone.py
            tests: "failover,stopstart,oom,resize"
            tierName: "Pro"
            cloudProvider: aws
            cloudRegion: us-east-1
            resourceKey: standalone
            instanceType: t2.medium
            newInstanceType: m6i.large
            maxmemory: "2GB"

          - name: "[04] pro/SingleZone - AWS/us-east-1"
            if: "basic"
            testFile: tests/test_grouped_replication.py
            tests: "failover,stopstart,oom,resize"
            tierName: "Pro"
            cloudProvider: aws
            cloudRegion: us-east-1
            resourceKey: single-Zone
            instanceType: t2.medium
            newInstanceType: m6i.large
            maxmemory: "2GB"

          - name: "[05] pro/MultiZone - AWS/us-east-1"
            if: "basic"
            testFile: tests/test_grouped_replication.py
            tests: "failover,stopstart,oom,resize"
            tierName: "Pro"
            cloudProvider: aws
            cloudRegion: us-east-1
            resourceKey: multi-Zone
            instanceType: t2.medium
            newInstanceType: m6i.large
            maxmemory: "2GB"

          - name: "[06] pro/ClusterSingleZone - AWS/us-east-1"
            if: "basic"
            testFile: tests/test_grouped_cluster.py
            tests: "failover,stopstart,oom,resize"
            tierName: "Pro"
            cloudProvider: aws
            cloudRegion: us-east-1
            resourceKey: cluster-Single-Zone
            instanceType: t2.medium
            hostCount: "6"
            clusterReplicas: "1"
            newInstanceType: m6i.large
            maxmemory: "2GB"

          - name: "[07] pro/ClusterMultiZone - AWS/us-east-1"
            if: "basic"
            testFile: tests/test_grouped_cluster.py
            tests: "failover,stopstart,oom,resize"
            tierName: "Pro"
            cloudProvider: aws
            cloudRegion: us-east-1
            resourceKey: cluster-Multi-Zone
            instanceType: t2.medium
            hostCount: "6"
            clusterReplicas: "1"
            newInstanceType: m6i.large
            maxmemory: "2GB"

          ######################## PRO â€¢ AWS (TLS - BASIC) ########################
          - name: "[08] pro/Standalone/TLS - AWS/us-east-1"
            if: "basic"
            testFile: tests/test_grouped_standalone.py
            tests: "failover,stopstart"
            tierName: "Pro"
            cloudProvider: aws
            cloudRegion: us-east-1
            resourceKey: standalone
            instanceType: t2.medium
            maxmemory: "2GB"
            tls: true

          - name: "[09] pro/SingleZone/TLS - AWS/us-east-1"
            if: "basic"
            testFile: tests/test_grouped_replication.py
            tests: "failover,stopstart"
            tierName: "Pro"
            cloudProvider: aws
            cloudRegion: us-east-1
            resourceKey: single-Zone
            instanceType: t2.medium
            maxmemory: "2GB"
            tls: true

          - name: "[10] pro/ClusterSingleZone/TLS - AWS/us-east-1"
            if: "basic"
            testFile: tests/test_grouped_cluster.py
            tests: "failover,stopstart"
            tierName: "Pro"
            cloudProvider: aws
            cloudRegion: us-east-1
            resourceKey: cluster-Single-Zone
            instanceType: t2.medium
            hostCount: "6"
            clusterReplicas: "1"
            maxmemory: "2GB"
            tls: true

    steps:
      - name: Checkout
        if: (matrix.instances.if == 'basic' && (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.test_type == 'all'))) || (matrix.instances.if == 'full' && env.TEST_MODE == 'full')
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Set up Python
        if: (matrix.instances.if == 'basic' && (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.test_type == 'all'))) || (matrix.instances.if == 'full' && env.TEST_MODE == 'full')
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache Poetry virtualenv
        if: (matrix.instances.if == 'basic' && (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.test_type == 'all'))) || (matrix.instances.if == 'full' && env.TEST_MODE == 'full')
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry/virtualenvs
          key: ${{ runner.os }}-poetry-helm-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-poetry-helm-
            ${{ runner.os }}-poetry-

      - name: Install Poetry
        if: (matrix.instances.if == 'basic' && (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.test_type == 'all'))) || (matrix.instances.if == 'full' && env.TEST_MODE == 'full')
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install Python dependencies
        if: (matrix.instances.if == 'basic' && (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.test_type == 'all'))) || (matrix.instances.if == 'full' && env.TEST_MODE == 'full')
        run: |
          poetry install

      - name: ${{ matrix.instances.name }}
        if: (matrix.instances.if == 'basic' && (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.test_type == 'all'))) || (matrix.instances.if == 'full' && env.TEST_MODE == 'full')
        env:
          SERVICE_ID: ${{ vars.OMNISTRATE_INTERNAL_SERVICE_ID }}
          ENVIRONMENT_ID: ${{ vars.OMNISTRATE_INTERNAL_DEV_ENVIRONMENT }}
          SUBSCRIPTION_ID: sub-GJPV3NoNC0
          OMNISTRATE_USERNAME: ${{ secrets.OMNISTRATE_USERNAME }}
          OMNISTRATE_PASSWORD: ${{ secrets.OMNISTRATE_PASSWORD }}
        run: |
          set -euo pipefail

          EXTRA_ARGS=()

          [[ -n "${{ matrix.instances.newInstanceType || '' }}" ]] && \
            EXTRA_ARGS+=(--new-instance-type "${{ matrix.instances.newInstanceType }}")

          [[ -n "${{ matrix.instances.hostCount || '' }}" ]] && \
            EXTRA_ARGS+=(--host-count "${{ matrix.instances.hostCount }}")

          [[ -n "${{ matrix.instances.clusterReplicas || '' }}" ]] && \
            EXTRA_ARGS+=(--cluster-replicas "${{ matrix.instances.clusterReplicas }}")

          [[ -n "${{ matrix.instances.maxmemory || '' }}" ]] && \
            EXTRA_ARGS+=(--maxmemory "${{ matrix.instances.maxmemory }}")

          [[ -n "${{ matrix.instances.instanceType || '' }}" ]] && \
            EXTRA_ARGS+=(--instance-type "${{ matrix.instances.instanceType }}")

          [[ -n "${{ matrix.instances.tls || '' }}" ]] && \
            EXTRA_ARGS+=(--tls)

          poetry run pytest -s -v "${{ matrix.instances.testFile }}" \
            --service-id "$SERVICE_ID" \
            --environment-id "$ENVIRONMENT_ID" \
            --subscription-id "$SUBSCRIPTION_ID" \
            --tier-name "${{ matrix.instances.tierName }}" \
            --cloud-provider "${{ matrix.instances.cloudProvider }}" \
            --region "${{ matrix.instances.cloudRegion }}" \
            --resource-key "${{ matrix.instances.resourceKey }}" \
            --instance-name "helm-e2e-${{ matrix.instances.resourceKey }}-${{ github.run_id }}" \
            --e2e-steps "${{ matrix.instances.tests }}" \
            --network-type "${{ matrix.instances.networkType || 'PUBLIC' }}" \
            "${EXTRA_ARGS[@]}"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: omnistrate-e2e-test-results-${{ matrix.instances.name }}
          path: |
            .pytest_cache/
            test-results/

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, omnistrate-e2e-tests]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Omnistrate E2E Tests: ${{ needs.omnistrate-e2e-tests.result }}"

          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "âŒ Unit tests failed"
            exit 1
          fi

          if [ "${{ needs.integration-tests.result }}" != "success" ] && [ "${{ needs.integration-tests.result }}" != "skipped" ]; then
            echo "âŒ Integration tests failed"
            exit 1
          fi

          if [ "${{ needs.omnistrate-e2e-tests.result }}" != "success" ] && [ "${{ needs.omnistrate-e2e-tests.result }}" != "skipped" ]; then
            echo "âŒ Omnistrate E2E tests failed"
            exit 1
          fi

          echo "âœ… All tests passed!"

      - name: Post summary
        if: always()
        run: |
          echo "## ðŸ§ª Helm Chart Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Omnistrate E2E Tests | ${{ needs.omnistrate-e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ref:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
