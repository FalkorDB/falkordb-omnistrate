{{- /*
Creates per-pod Services with external-dns hostnames:
 - For all falkordb pods: <pod-name>.<hostname>
 - For replication mode, also for sentinel pods: <pod-name>.<hostname>
Runs post-install/upgrade to allow sharded components with dynamic names.
*/ -}}
{{- if and .Values.hostname (eq .Values.mode "cluster") }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "kblib.clusterName" . }}-per-pod-svc-script
  namespace: {{ .Release.Namespace }}
  labels: {{ include "kblib.clusterLabels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "10"
data:
  create-services.sh: |
    #!/bin/sh
    set -euo pipefail
    NAMESPACE='{{ .Release.Namespace }}'
    CLUSTER='{{ include "kblib.clusterName" . }}'
    HOSTNAME='{{ .Values.hostname }}'
    PORT='{{ .Values.port }}'
    NODE_PORT_ENABLED='{{ .Values.nodePortEnabled }}'
    echo "Waiting for cluster $CLUSTER to be Running..."
    while true; do
      PHASE=$(kubectl get cluster "$CLUSTER" -n "$NAMESPACE" -o jsonpath='{.status.phase}' 2>/dev/null || echo "")
      [ "$PHASE" = "Running" ] && break
      echo "Cluster phase: $PHASE, waiting..."; sleep 5
    done
    echo "Waiting for pods to be Ready..."
    kubectl wait --for=condition=ready pod -l app.kubernetes.io/instance="$CLUSTER" -n "$NAMESPACE" --timeout=300s || true
    create_svc_for_pods() {
      local selector="$1"
      echo "Listing pods with selector: $selector"
      pods=$(kubectl get pods -n "$NAMESPACE" -l "$selector" -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}')
      echo "$pods" | while read -r POD; do
        [ -z "$POD" ] && continue
        SVC_NAME="${POD}-external"
        FQDN="${POD}.${HOSTNAME}"
        if kubectl get svc "$SVC_NAME" -n "$NAMESPACE" >/dev/null 2>&1; then
          echo "Service $SVC_NAME already exists"
          continue
        fi
        echo "Creating service $SVC_NAME"
        kubectl create service clusterip "$SVC_NAME" --tcp="$PORT:$PORT" -n "$NAMESPACE" --dry-run=client -o yaml | kubectl apply -f -
        kubectl patch svc "$SVC_NAME" -n "$NAMESPACE" --type merge -p '{"metadata":{"annotations":{"external-dns.alpha.kubernetes.io/hostname":"'"$FQDN"'"}}}'  || true
        kubectl patch svc "$SVC_NAME" -n "$NAMESPACE" --type merge -p '{"spec":{"selector":{"apps.kubeblocks.io/pod-name":"'"$POD"'"}}}'  || true
      done
    }
    create_svc_for_pods "app.kubernetes.io/instance=${CLUSTER},apps.kubeblocks.io/component-name=falkordb"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "kblib.clusterName" . }}-per-pod-svc
  namespace: {{ .Release.Namespace }}
  labels: {{ include "kblib.clusterLabels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "15"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 6
  template:
    metadata:
      name: {{ include "kblib.clusterName" . }}-per-pod-svc
    spec:
      restartPolicy: OnFailure
      serviceAccountName: {{ include "kblib.clusterName" . }}-per-pod-svc-sa
      containers:
      - name: create-per-pod-services
        image: alpine/k8s:1.28.3
        volumeMounts:
        - name: script
          mountPath: /scripts
          readOnly: true
        command:
        - /bin/sh
        - /scripts/create-services.sh
      volumes:
      - name: script
        configMap:
          name: {{ include "kblib.clusterName" . }}-per-pod-svc-script
          defaultMode: 0755
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "kblib.clusterName" . }}-per-pod-svc-sa
  namespace: {{ .Release.Namespace }}
  labels: {{ include "kblib.clusterLabels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "12"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "kblib.clusterName" . }}-per-pod-svc-role
  namespace: {{ .Release.Namespace }}
  labels: {{ include "kblib.clusterLabels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "12"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
rules:
- apiGroups: [""]
  resources: ["pods", "services"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
- apiGroups: ["apps.kubeblocks.io"]
  resources: ["clusters"]
  verbs: ["get", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "kblib.clusterName" . }}-per-pod-svc-binding
  namespace: {{ .Release.Namespace }}
  labels: {{ include "kblib.clusterLabels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "12"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "kblib.clusterName" . }}-per-pod-svc-role
subjects:
- kind: ServiceAccount
  name: {{ include "kblib.clusterName" . }}-per-pod-svc-sa
  namespace: {{ .Release.Namespace }}
{{- end }}
