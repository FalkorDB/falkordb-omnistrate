# GitHub Workflow for FalkorDB/falkordb-omnistrate repository
# Place at: .github/workflows/redis-crash-handler.yml

name: Redis Crash Handler

permissions:
  contents: read
  issues: write

on:
  workflow_dispatch:
    inputs:
      pod:
        description: 'Pod name'
        required: true
        type: string
      namespace:
        description: 'Namespace (subscription ID)'
        required: true
        type: string
      cluster:
        description: 'Cluster name'
        required: true
        type: string
      container:
        description: 'Container name (service)'
        required: true
        type: string
      vmauth_url:
        description: 'VMAuth URL for log collection'
        required: true
        type: string
      environment:
        description: 'Environment (dev or prod)'
        required: true
        type: string
env:
  ISSUE_REPO: 'FalkorDB/private'
  PROJECT_ID: 'PVT_kwDOCfJmL84AqS92'

jobs:
  handle-crash:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests
      
      - name: Set environment variables
        run: |
          if [ "${{ inputs.environment }}" = "dev" ]; then
            echo "OMNISTRATE_ENVIRONMENT_ID=${{ vars.OMNISTRATE_INTERNAL_DEV_ENVIRONMENT }}" >> $GITHUB_ENV
            echo "VMAUTH_PASSWORD=${{ secrets.VMAUTH_PASSWORD_DEV }}" >> $GITHUB_ENV
            echo "GRAFANA_URL=${{ vars.GRAFANA_URL_DEV }}" >> $GITHUB_ENV
          else
            echo "OMNISTRATE_ENVIRONMENT_ID=${{ vars.OMNISTRATE_INTERNAL_PROD_ENVIRONMENT }}" >> $GITHUB_ENV
            echo "VMAUTH_PASSWORD=${{ secrets.VMAUTH_PASSWORD_PROD }}" >> $GITHUB_ENV
            echo "GRAFANA_URL=${{ vars.GRAFANA_URL_PROD }}" >> $GITHUB_ENV
          fi
      
      - name: Process crash
        env:
          OMNISTRATE_API_URL: "https://api.omnistrate.cloud/2022-09-01-00/"
          OMNISTRATE_USERNAME: ${{ secrets.OMNISTRATE_USERNAME }}
          OMNISTRATE_PASSWORD: ${{ secrets.OMNISTRATE_PASSWORD }}
          OMNISTRATE_SERVICE_ID: ${{ vars.OMNISTRATE_INTERNAL_SERVICE_ID }}
          VMAUTH_USERNAME: ${{ vars.VMAUTH_USERNAME }}
          VMAUTH_PASSWORD: ${{ env.VMAUTH_PASSWORD }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GOOGLE_CHAT_WEBHOOK_URL: ${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}
          ISSUE_REPO: ${{ env.ISSUE_REPO }}
          GRAFANA_URL: ${{ env.GRAFANA_URL }}
        run: |
          python ./scripts/redis_crash_handler.py \
            --pod "${{ inputs.pod }}" \
            --namespace "${{ inputs.namespace }}" \
            --cluster "${{ inputs.cluster }}" \
            --container "${{ inputs.container }}" \
            --vmauth-url "${{ inputs.vmauth_url }}"
