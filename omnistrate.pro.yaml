version: "3.9"

x-omnistrate-service-plan:
  name: 'FalkorDB Pro'
  tenancyType: 'OMNISTRATE_DEDICATED_TENANCY'
  deployment:
    hostedDeployment:
      GcpProjectId: '$GcpProjectId'
      GcpProjectNumber: '$GcpProjectNumber'   
      GcpServiceAccountEmail: '$GcpServiceAccountEmail'

x-omnistrate-load-balancer:
  tcp:
    - name: Single Zone Sentinel LB
      description: L4 Load Balancer for Sentinel in Single Zone
      ports:
        - associatedResourceKeys:
            - node-sz
            - sentinel-sz
          ingressPort: 26379
          backendPort: 26379

    - name: Multi Zone Sentinel LB
      description: L4 Load Balancer for Sentinel in Multi Zone
      ports:
        - associatedResourceKeys:
            - node-mz
            - sentinel-mz
          ingressPort: 26379
          backendPort: 26379

x-omnistrate-integrations:
  - omnistrateAlerting:
  - omnistrateMetrics:
      additionalMetrics:
        node-s: 
          prometheusEndpoint: "http://localhost:9121/metrics"
          metrics:
            go_goroutines:
            go_info:
            go_gc_duration_seconds_sumgo_gc_duration_seconds_count:
            go_memstats_alloc_bytes:
            go_memstats_alloc_bytes_total:
            go_memstats_buck_hash_sys_bytes:
            go_memstats_frees_total:
            go_memstats_gc_sys_bytes:
            go_memstats_heap_alloc_bytes:
            go_memstats_heap_idle_bytes:
            go_memstats_heap_inuse_bytes:
            go_memstats_heap_objects:
            go_memstats_heap_released_bytes:
            go_memstats_heap_sys_bytes:
            go_memstats_last_gc_time_seconds:
            go_memstats_lookups_total:
            go_memstats_mallocs_total:
            go_memstats_mcache_inuse_bytes:
            go_memstats_mcache_sys_bytes:
            go_memstats_mspan_inuse_bytes:
            go_memstats_mspan_sys_bytes:
            go_memstats_next_gc_bytes:
            go_memstats_other_sys_bytes:
            go_memstats_stack_inuse_bytes:
            go_memstats_stack_sys_bytes:
            go_memstats_sys_bytes:
            go_threads:
            process_cpu_seconds_total:
            process_max_fds:
            process_open_fds:
            process_resident_memory_bytes:
            process_start_time_seconds:
            process_virtual_memory_bytes:
            process_virtual_memory_max_bytes:
            redis_active_defrag_running:
            redis_allocator_active_bytes:
            redis_allocator_allocated_bytes:
            redis_allocator_frag_bytes:
            redis_allocator_frag_ratio:
            redis_allocator_resident_bytes:
            redis_allocator_rss_bytes:
            redis_allocator_rss_ratio:
            redis_aof_base_size_bytes:
            redis_aof_buffer_length:
            redis_aof_current_rewrite_duration_sec:
            redis_aof_current_size_bytes:
            redis_aof_delayed_fsync:
            redis_aof_enabled:
            redis_aof_last_bgrewrite_status:
            redis_aof_last_cow_size_bytes:
            redis_aof_last_rewrite_duration_sec:
            redis_aof_last_write_status:
            redis_aof_pending_bio_fsync:
            redis_aof_pending_rewrite:
            redis_aof_rewrite_in_progress:
            redis_aof_rewrite_scheduled:
            redis_blocked_clients:
            redis_client_recent_max_input_buffer_bytes:
            redis_client_recent_max_output_buffer_bytes:
            redis_clients_in_timeout_table:
            redis_cluster_connections:
            redis_cluster_enabled:
            redis_commands_duration_seconds_total:
            redis_commands_failed_calls_total:
            redis_commands_latencies_usec_bucket:
            redis_commands_latencies_usec_sum:
            redis_commands_latencies_usec_count:
            redis_commands_processed_total:
            redis_commands_rejected_calls_total:
            redis_commands_total:
            redis_config_io_threads:
            redis_config_maxclients:
            redis_config_maxmemory:
            redis_connected_clients:
            redis_connected_slaves:
            redis_connections_received_total:
            redis_cpu_sys_children_seconds_total:
            redis_cpu_sys_main_thread_seconds_total:
            redis_cpu_sys_seconds_total:
            redis_cpu_user_children_seconds_total:
            redis_cpu_user_main_thread_seconds_total:
            redis_cpu_user_seconds_total:
            redis_db_avg_ttl_seconds:
            redis_db_keys:
            redis_db_keys_expiring:
            redis_defrag_hits:
            redis_defrag_key_hits:
            redis_defrag_key_misses:
            redis_defrag_misses:
            redis_dump_payload_sanitizations:
            redis_errors_total:
            redis_evicted_keys_total:
            redis_expired_keys_total:
            redis_expired_stale_percentage:
            redis_expired_time_cap_reached_total:
            redis_exporter_build_info:
            redis_exporter_last_scrape_connect_time_seconds:
            redis_exporter_last_scrape_duration_seconds:
            redis_exporter_last_scrape_error:
            redis_exporter_scrape_duration_seconds_sum:
            redis_exporter_scrape_duration_seconds_count:
            redis_exporter_scrapes_total:
            redis_instance_info:
            redis_io_threaded_reads_processed:
            redis_io_threaded_writes_processed:
            redis_io_threads_active:
            redis_keyspace_hits_total:
            redis_keyspace_misses_total:
            redis_last_key_groups_scrape_duration_milliseconds:
            redis_last_slow_execution_duration_seconds:
            redis_latency_percentiles_usec:
            redis_latency_percentiles_usec_sum:
            redis_latency_percentiles_usec_count:
            redis_latest_fork_seconds:
            redis_lazyfree_pending_objects:
            redis_loading_dump_file:
            redis_master_last_io_seconds_ago:
            redis_master_link_up:
            redis_master_repl_offset:
            redis_master_sync_in_progress:
            redis_mem_clients_normal:
            redis_mem_clients_slaves:
            redis_mem_fragmentation_bytes:
            redis_mem_fragmentation_ratio:
            redis_mem_not_counted_for_eviction_bytes:
            redis_mem_total_replication_buffers_bytes:
            redis_memory_max_bytes:
            redis_memory_used_bytes:
            redis_memory_used_dataset_bytes:
            redis_memory_used_lua_bytes:
            redis_memory_used_overhead_bytes:
            redis_memory_used_peak_bytes:
            redis_memory_used_rss_bytes:
            redis_memory_used_scripts_bytes:
            redis_memory_used_startup_bytes:
            redis_migrate_cached_sockets_total:
            redis_module_fork_in_progress:
            redis_module_fork_last_cow_size:
            redis_net_input_bytes_total:
            redis_net_output_bytes_total:
            redis_number_of_cached_scripts:
            redis_process_id:
            redis_pubsub_channels:
            redis_pubsub_patterns:
            redis_pubsubshard_channels:
            redis_rdb_bgsave_in_progress:
            redis_rdb_changes_since_last_save:
            redis_rdb_current_bgsave_duration_sec:
            redis_rdb_last_bgsave_duration_sec:
            redis_rdb_last_bgsave_status:
            redis_rdb_last_cow_size_bytes:
            redis_rdb_last_load_expired_keys:
            redis_rdb_last_load_loaded_keys:
            redis_rdb_last_save_timestamp_seconds:
            redis_rdb_saves_total:
            redis_rejected_connections_total:
            redis_repl_backlog_first_byte_offset:
            redis_repl_backlog_history_bytes:
            redis_repl_backlog_is_active:
            redis_replica_partial_resync_accepted:
            redis_replica_partial_resync_denied:
            redis_replica_resyncs_full:
            redis_replication_backlog_bytes:
            redis_second_repl_offset:
            redis_slave_expires_tracked_keys:
            redis_slave_info:
            redis_slave_priority:
            redis_slave_repl_offset:
            redis_slowlog_last_id:
            redis_slowlog_length:
            redis_start_time_seconds:
            redis_target_scrape_request_errors_total:
            redis_total_error_replies:
            redis_total_reads_processed:
            redis_total_writes_processed:
            redis_tracking_clients:
            redis_tracking_total_items:
            redis_tracking_total_keys:
            redis_tracking_total_prefixes:
            redis_unexpected_error_replies:
            redis_up:
            redis_uptime_in_seconds:

        

services:

# Standalone

  Standalone:
    x-omnistrate-mode-internal: false
    image: omnistrate/noop
    x-omnistrate-api-params:
      - key: name
        description: Name
        name: Name
        type: String
        modifiable: true
        required: false
        defaultValue: My favorite database
        export: true
      - key: description
        description: Description
        name: Description
        type: String
        modifiable: true
        required: false
        defaultValue: The best graph database in the world
        export: true
      - key: nodeInstanceType
        description: The size of the node instance. Check the documentation for more information.
        name: Node Instance Type
        type: String
        modifiable: false
        required: true
        export: true
        defaultValue: e2-custom-4-10240
        options:
          - e2-custom-4-10240
          - e2-custom-8-18432
          - e2-custom-16-34816
          - e2-custom-32-69632
        parameterDependencyMap:
          node-s: nodeInstanceType
      - key: enableTLS
        description: Whether to enable TLS for the database
        name: Enable TLS
        type: Boolean
        modifiable: false
        required: true
        export: true
        defaultValue: "false"
        parameterDependencyMap:
          node-s: enableTLS
      - key: falkordbUser
        description: Choose a default username for your database
        name: FalkorDB User
        type: String
        modifiable: false
        required: true
        export: true
        defaultValue: "falkordb"
        parameterDependencyMap:
          node-s: falkordbUser
      - key: falkordbPassword
        description: Choose a default password for your database
        name: FalkorDB Password
        type: String
        modifiable: false
        required: true
        export: false
        parameterDependencyMap:
          node-s: falkordbPassword
      - key: storageSize
        description: Minimum 10Gi (10). Recommended to be at least 3x the size of the data set. Check the documentation for more information.
        name: Disk Size (in Gi)
        type: String
        defaultValue: "30"
        modifiable: false
        required: true
        export: true
        options:
          - "30"
          - "40"
          - "50"
          - "60"
          - "70"
          - "80"
          - "90"
          - "100"
          - "120"
          - "140"
          - "160"
          - "180"
          - "200"
          - "220"
          - "240"
          - "260"
          - "280"
          - "300"
          - "350"
          - "400"
          - "450"
          - "500"
        parameterDependencyMap:
          node-s: storageSize
      - key: RDBPersistenceConfig
        description: How often to save the RDB file to disk. Check the documentation for more information.
        name: RDB Persistence Config
        type: String
        modifiable: false
        required: false
        export: true
        defaultValue: "low"
        options:
          - "low"
          - "medium"
          - "high"
        parameterDependencyMap:
          node-s: RDBPersistenceConfig
      - key: AOFPersistenceConfig
        description: Whether to enable AOF persistence. Check the documentation for more information.
        name: AOF Persistence Config
        type: String
        modifiable: false
        required: false
        export: true
        defaultValue: "no"
        options:
          - "no"
          - "everysec"
          - "always"
        parameterDependencyMap:
          node-s: AOFPersistenceConfig
    depends_on:
      - node-s

  node-s:
    x-omnistrate-mode-internal: true
    image: $FalkorDBNodeImage
    x-omnistrate-compute:
      replicaCount: 1
      instanceTypes:
        - cloudProvider: gcp
          apiParam: nodeInstanceType
    x-omnistrate-api-params:
      - key: nodeInstanceType
        description: The size of the node instance. Check the documentation for more information.
        name: Node Instance Type
        type: String
        modifiable: false
        required: true
        export: true
        defaultValue: e2-custom-4-10240
        options:
          - e2-custom-4-10240
          - e2-custom-8-18432
          - e2-custom-16-34816
          - e2-custom-32-69632
      - key: enableTLS
        description: Whether to enable TLS for the database
        name: Enable TLS
        type: Boolean
        modifiable: false
        required: true
        export: true
        defaultValue: "false"
      - key: falkordbUser
        description: Choose a default username for your database
        name: FalkorDB User
        type: String
        modifiable: false
        required: true
        export: true
        defaultValue: "falkordb"
      - key: falkordbPassword
        description: Choose a default password for your database
        name: FalkorDB Password
        type: String
        modifiable: false
        required: true
        export: false
      - key: storageSize
        description: Minimum 10Gi (10). Recommended to be at least 3x the size of the data set. Check the documentation for more information.
        name: Disk Size (in Gi)
        type: String
        defaultValue: "30"
        modifiable: false
        required: true
        export: true
        options:
          - "30"
          - "40"
          - "50"
          - "60"
          - "70"
          - "80"
          - "90"
          - "100"
          - "120"
          - "140"
          - "160"
          - "180"
          - "200"
          - "220"
          - "240"
          - "260"
          - "280"
          - "300"
          - "350"
          - "400"
          - "450"
          - "500"
      - key: RDBPersistenceConfig
        description: How often to save the RDB file to disk. Check the documentation for more information.
        name: RDB Persistence Config
        type: String
        modifiable: false
        required: false
        export: true
        defaultValue: "low"
        options:
          - "low"
          - "medium"
          - "high"
      - key: AOFPersistenceConfig
        description: Whether to enable AOF persistence. Check the documentation for more information.
        name: AOF Persistence Config
        type: String
        modifiable: false
        required: false
        export: true
        defaultValue: "no"
        options:
          - "no"
          - "everysec"
          - "always"
    volumes:
      - source: ./data
        target: /data
        type: bind
        x-omnistrate-storage:
          gcp:
            instanceStorageType: GCP::PD_BALANCED
            instanceStorageSizeGiAPIParam: storageSize
    environment:
      - RUN_NODE=1
      - RUN_SENTINEL=0
      - RUN_METRICS=1
      - RUN_HEALTH_CHECK=1
      - BROWSER=0
      - NODE_HOST=$sys.network.node.externalEndpoint
      - NODE_PORT=6379
      - TLS=$var.enableTLS
      - FALKORDB_USER=$var.falkordbUser
      - FALKORDB_PASSWORD=$var.falkordbPassword
      - ADMIN_PASSWORD=$func.sha256($sys.id, 'bWQeQF72jMFPr')
      - DATA_DIR=/data
      - INSTANCE_TYPE=$var.nodeInstanceType
      - SECURITY_CONTEXT_USER_ID=0
      - SECURITY_CONTEXT_GROUP_ID=0
      - SECURITY_CONTEXT_FS_GROUP=0
      - ROOT_CA_PATH=/etc/ssl/certs/GlobalSign_Root_CA.pem
      - PERSISTENCE_RDB_CONFIG_INPUT=$var.RDBPersistenceConfig
      - PERSISTENCE_AOF_CONFIG=$var.AOFPersistenceConfig
    ports:
      - "6379:6379"
    x-omnistrate-capabilities:
      enableMultiZone: false
      enableEndpointPerReplica: true



# Single Zone

  Single-Zone:
    x-omnistrate-mode-internal: false
    image: omnistrate/noop
    x-omnistrate-api-params:
      - key: name
        description: Name
        name: Name
        type: String
        modifiable: true
        required: false
        defaultValue: FalkorDB Instance
        export: true
      - key: description
        description: Description
        name: Description
        type: String
        modifiable: true
        required: false
        defaultValue: FalkorDB Instance
        export: true
      - key: nodeInstanceType
        description: The size of the node instance. Check the documentation for more information.
        name: Node Instance Type
        type: String
        modifiable: false
        required: true
        export: true
        defaultValue: e2-custom-4-10240
        options:
          - e2-custom-4-10240
          - e2-custom-8-18432
          - e2-custom-16-34816
          - e2-custom-32-69632
        parameterDependencyMap:
          node-sz: nodeInstanceType
      - key: numReplicas
        description: Number of Replicas
        name: Number of Replicas
        type: Float64
        modifiable: true
        required: false
        export: true
        defaultValue: "2"
        options:
          - "2"
        parameterDependencyMap:
          node-sz: numReplicas
      - key: enableTLS
        description: Whether to enable TLS for the database
        name: Enable TLS
        type: Boolean
        modifiable: false
        required: true
        export: true
        defaultValue: "false"
        parameterDependencyMap:
          node-sz: enableTLS
      - key: falkordbUser
        description: Choose a default username for your database
        name: FalkorDB User
        type: String
        modifiable: false
        required: true
        export: true
        defaultValue: "falkordb"
        parameterDependencyMap:
          node-sz: falkordbUser
      - key: falkordbPassword
        description: Choose a default password for your database
        name: FalkorDB Password
        type: String
        modifiable: false
        required: true
        export: false
        parameterDependencyMap:
          node-sz: falkordbPassword
      - key: storageSize
        description: Minimum 10Gi (10). Recommended to be at least 3x the size of the data set. Check the documentation for more information.
        name: Disk Size (in Gi)
        type: String
        defaultValue: "30"
        modifiable: false
        required: true
        export: true
        options:
          - "30"
          - "40"
          - "50"
          - "60"
          - "70"
          - "80"
          - "90"
          - "100"
          - "120"
          - "140"
          - "160"
          - "180"
          - "200"
          - "220"
          - "240"
          - "260"
          - "280"
          - "300"
          - "350"
          - "400"
          - "450"
          - "500"
        parameterDependencyMap:
          node-sz: storageSize
      - key: RDBPersistenceConfig
        description: How often to save the RDB file to disk. Check the documentation for more information.
        name: RDB Persistence Config
        type: String
        modifiable: false
        required: false
        export: true
        defaultValue: "low"
        options:
          - "low"
          - "medium"
          - "high"
        parameterDependencyMap:
          node-sz: RDBPersistenceConfig
      - key: AOFPersistenceConfig
        description: Whether to enable AOF persistence. Check the documentation for more information.
        name: AOF Persistence Config
        type: String
        modifiable: false
        required: false
        export: true
        defaultValue: "no"
        options:
          - "no"
          - "everysec"
          - "always"
        parameterDependencyMap:
          node-sz: AOFPersistenceConfig
    depends_on:
      - node-sz

  node-sz:
    x-omnistrate-mode-internal: true
    image: $FalkorDBNodeImage
    x-omnistrate-compute:
      replicaCountAPIParam: numReplicas
      instanceTypes:
        - cloudProvider: gcp
          apiParam: nodeInstanceType
    x-omnistrate-api-params:
      - key: nodeInstanceType
        description: The size of the node instance. Check the documentation for more information.
        name: Node Instance Type
        type: String
        modifiable: false
        required: true
        export: true
        defaultValue: e2-custom-4-10240
        options:
          - e2-custom-4-10240
          - e2-custom-8-18432
          - e2-custom-16-34816
          - e2-custom-32-69632
      - key: numReplicas
        description: Number of Replicas
        name: Number of Replicas
        type: Float64
        modifiable: true
        required: false
        export: true
        defaultValue: "2"
        options:
          - "2"
      - key: enableTLS
        description: Whether to enable TLS for the database
        name: Enable TLS
        type: Boolean
        modifiable: false
        required: true
        export: true
        defaultValue: "false"
        parameterDependencyMap:
          sentinel-sz: enableTLS
      - key: falkordbUser
        description: Choose a default username for your database
        name: FalkorDB User
        type: String
        modifiable: false
        required: true
        export: true
        defaultValue: "falkordb"
      - key: falkordbPassword
        description: Choose a default password for your database
        name: FalkorDB Password
        type: String
        modifiable: false
        required: true
        export: false
        parameterDependencyMap:
          sentinel-sz: falkordbPassword
      - key: storageSize
        description: Minimum 10Gi (10). Recommended to be at least 3x the size of the data set. Check the documentation for more information.
        name: Disk Size (in Gi)
        type: String
        defaultValue: "30"
        modifiable: false
        required: true
        export: true
        options:
          - "30"
          - "40"
          - "50"
          - "60"
          - "70"
          - "80"
          - "90"
          - "100"
          - "120"
          - "140"
          - "160"
          - "180"
          - "200"
          - "220"
          - "240"
          - "260"
          - "280"
          - "300"
          - "350"
          - "400"
          - "450"
          - "500"
      - key: RDBPersistenceConfig
        description: How often to save the RDB file to disk. Check the documentation for more information.
        name: RDB Persistence Config
        type: String
        modifiable: false
        required: false
        export: true
        defaultValue: "low"
        options:
          - "low"
          - "medium"
          - "high"
      - key: AOFPersistenceConfig
        description: Whether to enable AOF persistence. Check the documentation for more information.
        name: AOF Persistence Config
        type: String
        modifiable: false
        required: false
        export: true
        defaultValue: "no"
        options:
          - "no"
          - "everysec"
          - "always"
    volumes:
      - source: ./data
        target: /data
        type: bind
        x-omnistrate-storage:
          gcp:
            instanceStorageType: GCP::PD_BALANCED
            instanceStorageSizeGiAPIParam: storageSize
    environment:
      - RUN_NODE=1
      - RUN_SENTINEL=1
      - RUN_METRICS=1
      - RUN_HEALTH_CHECK=1
      - BROWSER=0
      - SENTINEL_HOST=$sentinel-sz.sys.network.externalClusterEndpoint
      - NODE_HOST=$sys.network.node.externalEndpoint
      - NODE_PORT=6379
      - TLS=$var.enableTLS
      - FALKORDB_USER=$var.falkordbUser
      - FALKORDB_PASSWORD=$var.falkordbPassword
      - ADMIN_PASSWORD=$func.sha256($sys.id, 'bWQeQF72jMFPr')
      - DATA_DIR=/data
      - INSTANCE_TYPE=$var.nodeInstanceType
      - SECURITY_CONTEXT_USER_ID=0
      - SECURITY_CONTEXT_GROUP_ID=0
      - SECURITY_CONTEXT_FS_GROUP=0
      - ROOT_CA_PATH=/etc/ssl/certs/GlobalSign_Root_CA.pem
      - PERSISTENCE_RDB_CONFIG_INPUT=$var.RDBPersistenceConfig
      - PERSISTENCE_AOF_CONFIG=$var.AOFPersistenceConfig
    ports:
      - "6379:6379"
      - "26379:26379"
    x-omnistrate-capabilities:
      enableMultiZone: false
      enableEndpointPerReplica: true
    x-omnistrate-actionhooks:
      - scope: NODE
        type: HEALTH_CHECK
        commandTemplate: >
          #!/bin/bash

          HEALTH_CHECK_URL="${HEALTH_CHECK_HOST:-localhost}:${HEALTH_CHECK_PORT:-8081}/healthcheck"

          call_health_check() {

            echo "Health check URL: $HEALTH_CHECK_URL"
            curl -sf $HEALTH_CHECK_URL
            
            if [ $? -ne 0 ]; then
              echo "Health check failed"
              exit 1
            fi
          }

          call_health_check
    depends_on:
      - sentinel-sz

  sentinel-sz:
    x-omnistrate-mode-internal: true
    image: $FalkorDBNodeImage
    x-omnistrate-compute:
      replicaCount: 1
      instanceTypes:
        - cloudProvider: gcp
          name: e2-small
    environment:
      - RUN_NODE=0
      - RUN_SENTINEL=1
      - RUN_METRICS=0
      - SENTINEL_PORT=26379
      - TLS=$var.enableTLS
      - FALKORDB_PASSWORD=$var.falkordbPassword
      - ADMIN_PASSWORD=$func.sha256($sys.id, 'bWQeQF72jMFPr')
      - DATA_DIR=/data
      - SECURITY_CONTEXT_USER_ID=0
      - SECURITY_CONTEXT_GROUP_ID=0
      - SECURITY_CONTEXT_FS_GROUP=0
      - ROOT_CA_PATH=/etc/ssl/certs/GlobalSign_Root_CA.pem
    ports:
      - "26379:26379"
    volumes:
      - source: ./data
        target: /data
        type: bind
        x-omnistrate-storage:
          gcp:
            instanceStorageType: GCP::PD_BALANCED
            instanceStorageSizeGi: 10
    x-omnistrate-capabilities:
      enableMultiZone: false
      enableEndpointPerReplica: true
    x-omnistrate-api-params:
      - key: enableTLS
        description: Whether to enable TLS for the database
        name: Enable TLS
        type: Boolean
        modifiable: false
        required: true
        export: true
        defaultValue: "false"
      - key: falkordbPassword
        description: Choose a default password for your database
        name: FalkorDB Password
        type: String
        modifiable: false
        required: true
        export: false


# Multi Zone

  Multi-Zone:
    x-omnistrate-mode-internal: false
    image: omnistrate/noop
    x-omnistrate-api-params:
      - key: name
        description: Name
        name: Name
        type: String
        modifiable: true
        required: false
        defaultValue: FalkorDB Instance
        export: true
      - key: description
        description: Description
        name: Description
        type: String
        modifiable: true
        required: false
        defaultValue: FalkorDB Instance
        export: true
      - key: nodeInstanceType
        description: The size of the node instance. Check the documentation for more information.
        name: Node Instance Type
        type: String
        modifiable: false
        required: true
        export: true
        defaultValue: e2-custom-4-10240
        options:
          - e2-custom-4-10240
          - e2-custom-8-18432
          - e2-custom-16-34816
          - e2-custom-32-69632
        parameterDependencyMap:
          node-mz: nodeInstanceType
      - key: numReplicas
        description: Number of Replicas
        name: Number of Replicas
        type: Float64
        modifiable: true
        required: false
        export: true
        defaultValue: "2"
        options:
          - "2"
        parameterDependencyMap:
          node-mz: numReplicas
      - key: enableTLS
        description: Whether to enable TLS for the database
        name: Enable TLS
        type: Boolean
        modifiable: false
        required: true
        export: true
        defaultValue: "false"
        parameterDependencyMap:
          node-mz: enableTLS
      - key: falkordbUser
        description: Choose a default username for your database
        name: FalkorDB User
        type: String
        modifiable: false
        required: true
        export: true
        defaultValue: "falkordb"
        parameterDependencyMap:
          node-mz: falkordbUser
      - key: falkordbPassword
        description: Choose a default password for your database
        name: FalkorDB Password
        type: String
        modifiable: false
        required: true
        export: false
        parameterDependencyMap:
          node-mz: falkordbPassword
      - key: storageSize
        description: Minimum 10Gi (10). Recommended to be at least 3x the size of the data set. Check the documentation for more information.
        name: Disk Size (in Gi)
        type: String
        defaultValue: "30"
        modifiable: false
        required: true
        export: true
        options:
          - "30"
          - "40"
          - "50"
          - "60"
          - "70"
          - "80"
          - "90"
          - "100"
          - "120"
          - "140"
          - "160"
          - "180"
          - "200"
          - "220"
          - "240"
          - "260"
          - "280"
          - "300"
          - "350"
          - "400"
          - "450"
          - "500"
        parameterDependencyMap:
          node-mz: storageSize
      - key: RDBPersistenceConfig
        description: How often to save the RDB file to disk. Check the documentation for more information.
        name: RDB Persistence Config
        type: String
        modifiable: false
        required: false
        export: true
        defaultValue: "low"
        options:
          - "low"
          - "medium"
          - "high"
        parameterDependencyMap:
          node-mz: RDBPersistenceConfig
      - key: AOFPersistenceConfig
        description: Whether to enable AOF persistence. Check the documentation for more information.
        name: AOF Persistence Config
        type: String
        modifiable: false
        required: false
        export: true
        defaultValue: "no"
        options:
          - "no"
          - "everysec"
          - "always"
        parameterDependencyMap:
          node-mz: AOFPersistenceConfig
    depends_on:
      - node-mz

  node-mz:
    x-omnistrate-mode-internal: true
    image: $FalkorDBNodeImage
    x-omnistrate-compute:
      replicaCountAPIParam: numReplicas
      instanceTypes:
        - cloudProvider: gcp
          apiParam: nodeInstanceType
    x-omnistrate-api-params:
      - key: nodeInstanceType
        description: The size of the node instance. Check the documentation for more information.
        name: Node Instance Type
        type: String
        modifiable: false
        required: true
        export: true
        defaultValue: e2-custom-4-10240
        options:
          - e2-custom-4-10240
          - e2-custom-8-18432
          - e2-custom-16-34816
          - e2-custom-32-69632
      - key: numReplicas
        description: Number of Replicas
        name: Number of Replicas
        type: Float64
        modifiable: true
        required: false
        export: true
        defaultValue: "2"
        options:
          - "2"
      - key: enableTLS
        description: Whether to enable TLS for the database
        name: Enable TLS
        type: Boolean
        modifiable: false
        required: true
        export: true
        defaultValue: "false"
        parameterDependencyMap:
          sentinel-mz: enableTLS
      - key: falkordbUser
        description: Choose a default username for your database
        name: FalkorDB User
        type: String
        modifiable: false
        required: true
        export: true
        defaultValue: "falkordb"
      - key: falkordbPassword
        description: Choose a default password for your database
        name: FalkorDB Password
        type: String
        modifiable: false
        required: true
        export: false
        parameterDependencyMap:
          sentinel-mz: falkordbPassword
      - key: storageSize
        description: Minimum 10Gi (10). Recommended to be at least 3x the size of the data set. Check the documentation for more information.
        name: Disk Size (in Gi)
        type: String
        defaultValue: "30"
        modifiable: false
        required: true
        export: true
        options:
          - "30"
          - "40"
          - "50"
          - "60"
          - "70"
          - "80"
          - "90"
          - "100"
          - "120"
          - "140"
          - "160"
          - "180"
          - "200"
          - "220"
          - "240"
          - "260"
          - "280"
          - "300"
          - "350"
          - "400"
          - "450"
          - "500"
      - key: RDBPersistenceConfig
        description: How often to save the RDB file to disk. Check the documentation for more information.
        name: RDB Persistence Config
        type: String
        modifiable: false
        required: false
        export: true
        defaultValue: "low"
        options:
          - "low"
          - "medium"
          - "high"
      - key: AOFPersistenceConfig
        description: Whether to enable AOF persistence. Check the documentation for more information.
        name: AOF Persistence Config
        type: String
        modifiable: false
        required: false
        export: true
        defaultValue: "no"
        options:
          - "no"
          - "everysec"
          - "always"
    volumes:
      - source: ./data
        target: /data
        type: bind
        x-omnistrate-storage:
          gcp:
            instanceStorageType: GCP::PD_BALANCED
            instanceStorageSizeGiAPIParam: storageSize
    environment:
      - RUN_NODE=1
      - RUN_SENTINEL=1
      - RUN_METRICS=1
      - RUN_HEALTH_CHECK=1
      - BROWSER=0
      - SENTINEL_HOST=$sentinel-mz.sys.network.externalClusterEndpoint
      - NODE_HOST=$sys.network.node.externalEndpoint
      - NODE_PORT=6379
      - TLS=$var.enableTLS
      - FALKORDB_USER=$var.falkordbUser
      - FALKORDB_PASSWORD=$var.falkordbPassword
      - ADMIN_PASSWORD=$func.sha256($sys.id, 'bWQeQF72jMFPr')
      - DATA_DIR=/data
      - INSTANCE_TYPE=$var.nodeInstanceType
      - SECURITY_CONTEXT_USER_ID=0
      - SECURITY_CONTEXT_GROUP_ID=0
      - SECURITY_CONTEXT_FS_GROUP=0
      - ROOT_CA_PATH=/etc/ssl/certs/GlobalSign_Root_CA.pem
      - PERSISTENCE_RDB_CONFIG_INPUT=$var.RDBPersistenceConfig
      - PERSISTENCE_AOF_CONFIG=$var.AOFPersistenceConfig
    ports:
      - "6379:6379"
      - "26379:26379"
    x-omnistrate-capabilities:
      enableMultiZone: true
      enableEndpointPerReplica: true
    x-omnistrate-actionhooks:
      - scope: NODE
        type: HEALTH_CHECK
        commandTemplate: >
          #!/bin/bash

          HEALTH_CHECK_URL="${HEALTH_CHECK_HOST:-localhost}:${HEALTH_CHECK_PORT:-8081}/healthcheck"

          call_health_check() {

            echo "Health check URL: $HEALTH_CHECK_URL"
            curl -sf $HEALTH_CHECK_URL
            
            if [ $? -ne 0 ]; then
              echo "Health check failed"
              exit 1
            fi
          }

          call_health_check
    depends_on:
      - sentinel-mz

  sentinel-mz:
    x-omnistrate-mode-internal: true
    image: $FalkorDBNodeImage
    x-omnistrate-compute:
      replicaCount: 1
      instanceTypes:
        - cloudProvider: gcp
          name: e2-small
    environment:
      - RUN_NODE=0
      - RUN_SENTINEL=1
      - RUN_METRICS=0
      - SENTINEL_PORT=26379
      - TLS=$var.enableTLS
      - FALKORDB_PASSWORD=$var.falkordbPassword
      - ADMIN_PASSWORD=$func.sha256($sys.id, 'bWQeQF72jMFPr')
      - DATA_DIR=/data
      - SECURITY_CONTEXT_USER_ID=0
      - SECURITY_CONTEXT_GROUP_ID=0
      - SECURITY_CONTEXT_FS_GROUP=0
      - ROOT_CA_PATH=/etc/ssl/certs/GlobalSign_Root_CA.pem
    ports:
      - "26379:26379"
    volumes:
      - source: ./data
        target: /data
        type: bind
        x-omnistrate-storage:
          gcp:
            instanceStorageType: GCP::PD_BALANCED
            instanceStorageSizeGi: 10
    x-omnistrate-capabilities:
      enableMultiZone: false
      enableEndpointPerReplica: true
    x-omnistrate-api-params:
      - key: enableTLS
        description: Whether to enable TLS for the database
        name: Enable TLS
        type: Boolean
        modifiable: false
        required: true
        export: true
        defaultValue: "false"
      - key: falkordbPassword
        description: Choose a default password for your database
        name: FalkorDB Password
        type: String
        modifiable: false
        required: true
        export: false

