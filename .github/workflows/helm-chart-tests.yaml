name: Helm Chart Tests

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    paths:
      - "helm/kubeblocks/**"
      - ".github/workflows/helm-chart-tests.yaml"
  push:
    tags:
      - "v*"
    paths:
      - "helm/kubeblocks/**"
  schedule:
    - cron: "0 0 * * *" # Run daily at midnight UTC
  workflow_dispatch:
    inputs:
      test_type:
        description: "Type of tests to run"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - unit
          - integration

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NAMESPACE: falkordb-test
  CLUSTER_NAME: test-cluster
  PYTHON_VERSION: "3.11"
  KIND_VERSION: "v0.20.0"
  KUBECTL_VERSION: "v1.28.0"
  HELM_VERSION: "v3.13.0"
  KUBEBLOCKS_VERSION: "v1.0.1"

jobs:
  unit-tests:
    name: Unit Tests (Manifest Rendering)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
      - name: Checkout
        uses: actions/checkout@v5
        with:
          repository: apecloud/kubeblocks-addons
          path: helm/kubeblocks/kubeblocks-addons
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Cache Poetry virtualenv
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry/virtualenvs
          key: ${{ runner.os }}-poetry-helm-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-poetry-helm-
            ${{ runner.os }}-poetry-

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        working-directory: .
        run: |
          poetry install

      - name: Build Helm chart dependencies
        working-directory: helm/kubeblocks/falkordb-cluster-omnistrate
        run: |
          helm dependency build

      - name: Run unit tests
        working-directory: helm/kubeblocks/falkordb-cluster-omnistrate/tests
        run: |
          poetry run pytest -v -n 3 --dist=loadfile --tb=short \
            --cluster-name=${{ env.CLUSTER_NAME }} \
            --namespace=${{ env.NAMESPACE }} \
            unit/

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: |
            helm/kubeblocks/falkordb-cluster-omnistrate/tests/.pytest_cache/
            helm/kubeblocks/falkordb-cluster-omnistrate/tests/test-results/

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' && inputs.test_type != 'unit') ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.test_type != 'unit')
    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - name: "Standalone Mode Integration Tests"
            path: "integration/standalone"
          - name: "Replication Mode Integration Tests"
            path: "integration/replication"
          - name: "Cluster Mode Integration Tests"
            path: "integration/cluster"
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Checkout
        uses: actions/checkout@v5
        with:
          repository: apecloud/kubeblocks-addons
          path: helm/kubeblocks/kubeblocks-addons

      - name: Verify submodules
        run: |
          echo "Checking submodule status..."
          git submodule status
          echo "Listing kubeblocks-addons directory..."
          ls -la helm/kubeblocks/kubeblocks-addons/ || echo "Directory not found"
          if [ ! -d "helm/kubeblocks/kubeblocks-addons/addons" ]; then
            echo "Submodule content not found, initializing manually..."
            git submodule update --init --recursive
          fi
          echo "Final check:"
          ls -la helm/kubeblocks/kubeblocks-addons/addons/ || echo "Addons directory still not found"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: ${{ env.KUBECTL_VERSION }}

      - name: Set up Kind
        uses: helm/kind-action@v1
        with:
          version: ${{ env.KIND_VERSION }}
          cluster_name: falkordb-test
          config: helm/kubeblocks/falkordb-cluster-omnistrate/tests/kind-config.yaml
          wait: 300s

      - name: Verify cluster
        run: |
          kubectl cluster-info
          kubectl get nodes
          kubectl wait --for=condition=Ready nodes --all --timeout=300s

      - name: Cache Poetry virtualenv
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry/virtualenvs
          key: ${{ runner.os }}-poetry-helm-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-poetry-helm-
            ${{ runner.os }}-poetry-

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install Python dependencies
        run: |
          poetry install

      - name: Install KubeBlocks CRDs
        run: |
          kubectl create -f https://github.com/apecloud/kubeblocks/releases/download/${{ env.KUBEBLOCKS_VERSION }}/kubeblocks_crds.yaml

      - name: Add KubeBlocks Helm repo
        run: |
          helm repo add kubeblocks https://apecloud.github.io/helm-charts
          helm repo update

      - name: Install KubeBlocks
        run: |
          helm install kubeblocks kubeblocks/kubeblocks \
            --namespace kb-system \
            --version ${{ env.KUBEBLOCKS_VERSION }} \
            --create-namespace \
            --set autoInstalledAddons={} \
            --wait \
            --timeout 10m

      - name: Wait for KubeBlocks pods
        run: |
          kubectl wait --for=condition=Ready pods --all -n kb-system --timeout=300s
          kubectl get pods -n kb-system

      - name: Install FalkorDB addon
        run: |
          ADDON_PATH="helm/kubeblocks/kubeblocks-addons/addons/falkordb"
          if [ -d "$ADDON_PATH" ]; then
            echo "Building FalkorDB addon dependencies..."
            helm dependency build "$ADDON_PATH" || true
            echo "Installing FalkorDB addon..."
            helm upgrade --install falkordb --namespace kb-system "$ADDON_PATH" --wait --timeout 5m
            sleep 10
            kubectl -n kb-system get clusterdefinitions
          else
            echo "FalkorDB addon directory not found at $ADDON_PATH"
            ls -la helm/kubeblocks/kubeblocks-addons/ || echo "kubeblocks-addons directory not found"
            exit 1
          fi

      - name: Verify FalkorDB addon
        run: |
          timeout=60
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            status=$(kubectl -n kb-system get clusterdefinitions falkordb -o jsonpath='{.status.phase}' 2>/dev/null || echo "")
            if [ "$status" = "Available" ]; then
              echo "FalkorDB addon is enabled"
              break
            fi
            echo "Waiting for addon to be enabled... (${elapsed}s/${timeout}s)"
            sleep 5
            elapsed=$((elapsed + 5))
          done
          kubectl -n kb-system get clusterdefinitions falkordb -o yaml

      - name: Create test namespace
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Build Helm chart dependencies
        working-directory: helm/kubeblocks/falkordb-cluster-omnistrate
        run: |
          helm dependency build

      - name: Cleanup existing test resources
        working-directory: helm/kubeblocks/falkordb-cluster-omnistrate/tests
        run: |
          # Cleanup any existing helm releases
          if helm list -n ${{ env.NAMESPACE }} --all 2>/dev/null | grep -q "test-cluster"; then
            helm uninstall test-cluster -n ${{ env.NAMESPACE }} || true
            sleep 5
          fi

          # Cleanup any leftover PVCs
          kubectl delete pvc -n ${{ env.NAMESPACE }} -l app.kubernetes.io/instance=test-cluster --ignore-not-found=true || true

      - name: Run ${{ matrix.test-suite.name }}
        working-directory: helm/kubeblocks/falkordb-cluster-omnistrate/tests
        run: |
          poetry run pytest -v -s --tb=short \
            --cluster-name=${{ env.CLUSTER_NAME }} \
            --namespace=${{ env.NAMESPACE }} \
            ${{ matrix.test-suite.path }}

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Cluster Definitions ==="
          kubectl get clusterdefinitions -n kb-system

          echo "=== Clusters ==="
          kubectl get clusters -n ${{ env.NAMESPACE }}

          echo "=== Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide

          echo "=== Pod Logs ==="
          for pod in $(kubectl get pods -n ${{ env.NAMESPACE }} -o name); do
            echo "--- $pod ---"
            kubectl logs -n ${{ env.NAMESPACE }} $pod --all-containers --tail=100 || true
          done

          echo "=== Events ==="
          kubectl get events -n ${{ env.NAMESPACE }} --sort-by='.lastTimestamp'

          echo "=== KubeBlocks Pods ==="
          kubectl get pods -n kb-system

          echo "=== KubeBlocks Logs ==="
          for pod in $(kubectl get pods -n kb-system -o name); do
            echo "--- $pod ---"
            kubectl logs -n kb-system $pod --tail=100 || true
          done

      - name: Cleanup test resources
        if: always()
        run: |
          helm uninstall test-cluster -n ${{ env.NAMESPACE }} --ignore-not-found || true
          kubectl delete namespace ${{ env.NAMESPACE }} --ignore-not-found || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results-${{ matrix.test-suite.name }}
          path: |
            helm/kubeblocks/falkordb-cluster-omnistrate/tests/.pytest_cache/
            helm/kubeblocks/falkordb-cluster-omnistrate/tests/test-results/

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"

          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "âŒ Unit tests failed"
            exit 1
          fi

          if [ "${{ needs.integration-tests.result }}" != "success" ] && [ "${{ needs.integration-tests.result }}" != "skipped" ]; then
            echo "âŒ Integration tests failed"
            exit 1
          fi

          echo "âœ… All tests passed!"

      - name: Post summary
        if: always()
        run: |
          echo "## ðŸ§ª Helm Chart Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ref:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
